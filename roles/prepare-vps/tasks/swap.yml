---
- name: Check current swap status
  ansible.builtin.command:
    cmd: swapon --show=NAME --noheadings
  register: swap_current
  changed_when: false
  check_mode: false

- name: Check if swap file already exists
  ansible.builtin.stat:
    path: "/swap_space"
  register: swap_file_stat

- name: Display current swap information
  ansible.builtin.debug:
    msg:
      - "Current swap: {{ swap_current.stdout_lines }}"
      - "Swap file exists: {{ swap_file_stat.stat.exists }}"
  changed_when: false

- name: Create swap file if no swap is active
  ansible.builtin.shell:
    cmd: |
      dd if=/dev/zero of=/swap_space bs=2M count=1024 && \
      chmod 600 /swap_space && \
      mkswap /swap_space
    creates: /swap_space
  when:
    - swap_current.stdout == ""
    - not swap_file_stat.stat.exists

- name: Enable swap if file exists but not active
  ansible.builtin.command:
    cmd: swapon /swap_space
  when:
    - swap_current.stdout == ""
    - swap_file_stat.stat.exists
    - ansible_virtualization_type != "docker"
  register: swap_enable
  changed_when: swap_enable.rc == 0  # Only changed if successful

- name: Add swap to /etc/fstab if enabled
  ansible.builtin.lineinfile:
    path: /etc/fstab
    line: "/swap_space none swap sw 0 0"
    regexp: "^/swap_space"
    state: present
  when: swap_enable is defined and swap_enable.changed

- name: Set swapiness (optional)
  ansible.posix.sysctl:
    name: vm.swappiness
    value: "10"
    state: present
    reload: true

- name: Verify swap is active
  ansible.builtin.shell:
    cmd: free -h | grep Swap
  register: swap_verify
  changed_when: false

- name: Display final swap status
  ansible.builtin.debug:
    msg: "Swap status: {{ swap_verify.stdout }}"